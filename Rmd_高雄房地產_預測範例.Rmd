---
title: "高雄房地產_預測範例"
author: "CCW"
date: "2023-10-10"
output: html_document
---

## 互動式地圖視覺化與模型預測之探討–高雄房地產價格資訊系統之評價與實作
>
**<font size="5">第三部分：房價模型分析及預測</font>**
>
><font color="blue">
><font size="5">一、房價模型之建立</font>
>
首先將初級資料匯入R的工作區，當中有<span style="color:red">
22</span>個變數，資料取至臺灣經濟新報(TEJ)數據庫之不動產實價登錄系統，期間範圍為兩年(2019年7月1日至2021年6月30日)，資料筆數為30863筆，其資料結構如下R碼所示。
>

```{r}
df <- read.csv("./高雄房地產_預測範例.csv")
str(df)
```

>根據上述的資料結構，變更部分變數的屬性，將屬性為**<span style="color:red">chr</span>**轉換為**<span style="color:red">Factor</span>**。

```{r}
library(tidyverse)
df <- df %>% mutate_if(is.character,as.factor)
str(df)
```


>接著，查看資料檔內的建物型態有多少類型，並分別計算其相對應的筆數。

```{r}
levels(df$建物型態)
df %>% group_by(建物型態) %>% summarise(筆數=n())
```
>
>將資料檔**「建物型態」**之類別水準，分別建立其所屬資料子集。因**「住宅大樓(11層含以上有電梯)」**的筆數最多，所以後續將以該類建物示範其房價要如何預測。其餘不同類型建物的房價，都可按照以下的範例程序來預測。
>

```{r}
df_住宅大樓 <- filter(df, df$建物型態=="住宅大樓(11層含以上有電梯)") 
df_透天厝 <- filter(df, df$建物型態=="透天厝")  #6514 obs.
df_華廈 <- filter(df, df$建物型態=="華廈(10層含以下有電梯)")  
df_公寓 <- filter(df, df$建物型態=="公寓(5樓含以下無電梯)")   
df_套房 <- filter(df, df$建物型態=="套房(1房1廳1衛)")       
df_店面 <- filter(df, df$建物型態=="店面(店鋪)")      
df_工廠 <- filter(df, df$建物型態=="工廠")           
df_廠辦 <- filter(df, df$建物型態=="廠辦")           
df_其他 <- filter(df, df$建物型態=="其他")           
```
>
>檢視資料子集「df_住宅大樓」的變數個數與結構，並繼續必要的資料清理，以建立適切的資料子集，供後續的資料分析與預測模型之建立用。
```{r}
str(df_住宅大樓)
```
>
>因資料子集「df_住宅大樓」即為住宅大樓而設，所以刪除**「建物型態」**該欄位。另外，該資料子集的**「移轉樓層」**類別有218種之多，所以刪除**「移轉樓層」**該欄位，以利往後預測模型的建立。
>此時資料子集「df_住宅大樓」的所有**<span style="color:red">20</span>**個變數均與住宅大樓有關，與其它諸如透天、公寓等**「建物型態」**無關。至此，我們已初步完成資料子集「df_住宅大樓」資料清理的程序。簡單R碼如下：。

```{r}
df_住宅大樓 <- select(df_住宅大樓, -c(建物型態, 移轉樓層))
str(df_住宅大樓)
```

>
>為求變數間的相關，需再剔除些無關模型建立的變數，此時我們還需將資料子集「df_住宅大樓」的變數分類為兩群，第1群為量化變數(quantitative variables)，共有**<span style="color:red">7</span>**個;

```{r}
library(ClustOfVar)
quantity <- df_住宅大樓[,c("土地移轉坪數","總樓層","屋齡.年.","建物移轉坪數","車位總面積.坪.","單價.萬.坪.","車位總價.萬.")]
str(quantity)
```

>第2群為質性變數(qualitative variables)，共有**<span style="color:red">6</span>**個。

```{r}
quality <- df_住宅大樓[,c("鄉鎮市區","交易標的","臨路.Y.N.","都市土地使用分區","頂樓註記.Y.N.","管理組織.Y.N.")] 
str(quality)
```

>不論變數是量化或質性，我們可利用R套件{ClustOfVar}函數 ***hclustvar()*** 所提供的變數樹狀圖(variables dendrogram)，觀察資料子集「df_住宅大樓」變數間的相關性，以利後續預測迴歸的變數選取。另外，我們可以檢視產生變數集群需時多少。

```{r}
ptm <- proc.time()
tree <- hclustvar(quantity,quality)
proc.time()-ptm
```

>將變數集群後，產生變數樹狀圖，以利我們觀察變數間的相關程度。

```{r}
plot(tree)
```

>獲得變數相關樹狀圖之後，可分別將變數集合成2、3、4、5群不等的群變數(clustered variables)，要將資料變數分幾群，由使用者的背景知識來做主觀決定。
>若分成2群，其群變數的成分包括有:
>
```{r}
P2<-cutreevar(tree,2)
P2$var
```

>若分成3群，其群變數的成分包括有:
>

```{r}
P3<-cutreevar(tree,3)
P3$var
```

>若分成4群，其群變數的成分包括有:
>
```{r}
P4<-cutreevar(tree,4)
P4$var
```
>
>若分成5群，其群變數的成分包括有
>
```{r}
P5<-cutreevar(tree,5)
P5$var
```
>我們可將這些集群變數視為原變數的合成(synthesis)，所以集群變數有時被稱之為合成變數(synthesized variables)，因集群變數實為原變數的線性組合(linear combination)。


>今以**<font color="red">「P3$var的cluster2」</font>**群變數(共7個)為例，觀察原資料檔變數間的關係，用以建立預測每坪單價的迴歸方程，其R碼如下：

```{r}
X.quanti <- df_住宅大樓[,c("屋齡.年.","單價.萬.坪.","車位總價.萬.")]
str(X.quanti)
X.quali <- df_住宅大樓[,c("鄉鎮市區","臨路.Y.N.","都市土地使用分區","管理組織.Y.N.")] 
str(X.quali)
treeX <- hclustvar(X.quanti,X.quali)
plot(treeX)
```


>由上述的變數相關樹狀圖(dendrogram)可知，在這7個變數當中，建物(大樓住宅)的"單價.萬.坪."與"屋齡.年."和"車位總價.萬."的相關最高，與"臨路.Y.N."和"管理組織.Y.N."的相關次之，與"鄉鎮市區"和"都市土地使用分區"的相關最低。

>為求變數名能清晰易讀，我們將修正這7個質性與量化變數的變數名稱，R碼如下：

```{r}
df <- data.frame(cbind(X.quanti,X.quali))
str(df)
colnames(df) <- c("屋齡","單價","車位總價","鄉鎮市區","臨路","都市土地使用分區","管理組織")
str(df)
```
>
>接著就用這「單價」、「屋齡」、「車位總價」、「鄉鎮市區」、「臨路」、「都市土地使用分區」、「管理組織」等7個變數，來建立迴歸預測模型。


>但在建立迴歸預測模型前，我們需先選定一組測試每坪單價的迴歸方程所需的資料檔，用以檢視該每坪單價迴歸方程的預測能力。假設該測試資料共12筆，顯示如下:

```{r}
n <- sample(1:length(df$單價),12)
(test <- df[n,])
```

>選定12筆測試用資料後，即可建立每坪單價的迴歸方程模型，其簡單的R碼如下：

```{r}
price <- lm(單價~., data=df[-n,])
summary(price)
```

>由上述的模型係數的顯著性可知，自變數**<font color="red">「都市土地使用分區」</font>**對應變數**<font color="red">「單價」</font>**並未達到顯著(p值均遠大於0.05的一般公認水準)。
>上述迴歸方程模型建立後，再將之前的12筆測試資料匯入迴歸模型，以測試該模型的預測能力。

```{r}
原價 <- test$單價
test$單價 <- NULL
(預測 <- predict(price, test))
new <- data.frame(cbind(原價,round(預測,1)))
str(new)
colnames(new) <- c("原價", "預測")
new$誤差 <- ((new$原價-new$預測)^2)^0.5
str(new)
new$預測結果 <- with(new,ifelse(預測 > 原價, '高估', '低估'))
```

>**預測後的結果如下所示，值得注意的是這僅是一次隨機測試的結果，且預測高估與預測低估均會隨機出現，不會持續地顯現高估或低估的現象。另外要觀察的是，該估計所產生的誤差有多大。**
```{r}
options(width=120)
cbind(new, df_住宅大樓[n,c(1,2,7,9,11,12,18)])
```
>
>
><font size="5">二、迴歸模型變數增減的預測誤差比較</font>
>
>上述迴歸模型包含單價(應變數)在內，共有7個變數，姑且稱之為「7變數迴歸模型」。若增加迴歸模型的預測變數，例如包含單價(應變數)在內共有13個變數的「13變數迴歸模型」，其預測誤差(能力)是否會因而變小(增大)呢？我們可以建立兩組迴歸模型，分別為「7變數迴歸模型」與「13變數迴歸模型」，用相同的測試資料(例如隨機抽取12筆)加以比較這兩組迴歸模型的預測誤差，以究其優劣良窳。為方便說明筆較，我們就用上述的13變數樹狀圖的變數，來建立所需的「13變數迴歸模型」。該範例所需資料檔案已事先建立，以方便直接引用比較，而兩組資料檔名如下R碼所示。我們每一輪比較均先以10次為例，其相關R碼如下：

```{r}
rm(list=ls(all=TRUE))
library(tidyverse)
df_7v <- read.csv("./df_住宅大樓_7v.csv")
df_7v <- df_7v %>% mutate_if(is.character,as.factor)

df_13v <- read.csv("./df_住宅大樓_13v.csv")
df_13v <- df_13v %>% mutate_if(is.character,as.factor)

##############################################
k <- 10
誤差_7變數 = rep(0, k)
誤差_13變數 = rep(0, k)
for (i in 1:k){
  
n <- sample(1:length(df_7v$單價),10)
(test_7v <- df_7v[n,])
(test_13v <- df_13v[n,])
price_7v <- lm(單價~., data=df_7v[-n,])
summary(price_7v)
price_13v <- lm(單價~., data=df_13v[-n,]) 
summary(price_13v)

#用「7變數迴歸模型」預測房價
原價_7v <- test_7v$單價
test_7v$單價 <- NULL
(預測_7v <- predict(price_7v, test_7v))
new_7v <- data.frame(cbind(原價_7v,round(預測_7v,1)))
colnames(new_7v) <- c("原價", "預測")
new_7v$誤差 <- ((new_7v$原價-new_7v$預測)^2)^0.5
new_7v$預測結果 <- with(new_7v,ifelse(預測 > 原價, '高估', '低估'))
cbind(new_7v, df_7v[n,])

#用「13變數迴歸模型」預測房價
原價_13v <- test_13v$單價
test_13v$單價 <- NULL
預測_13v <- predict(price_13v, test_13v)
new_13v <- data.frame(cbind(原價_13v,round(預測_13v,1)))
colnames(new_13v) <- c("原價", "預測")
new_13v$誤差 <- ((new_13v$原價-new_13v$預測)^2)^0.5
new_13v$預測結果 <- with(new_13v,ifelse(預測 > 原價, '高估', '低估'))
誤差_7變數[i] <- sum(new_7v[,2])
誤差_13變數[i] <- sum(new_13v[,2])
}
```
>結束這一輪比較後，我們可觀察「7變數迴歸模型」與「13變數迴歸模型」在這10次預測誤差的細目比較。如同預期，「7變數迴歸模型」與「13變數迴歸模型」兩模型之預測誤差互有輸贏，不會有一面倒的情況出現。

```{r}
cbind(誤差_7變數,誤差_13變數)
```

>將這兩模型的10次預測誤差分別加總，以利這此次測試的總結比較。
>
```{r}
sum(誤差_7變數)
sum(誤差_13變數)
```
>
>最後，將「7變數迴歸模型」和「13變數迴歸模型」的兩組誤差編表比較，以檢視哪個迴歸模型的預測誤差較小。其R碼如下：

```{r}
誤差比較 <- as.data.frame(cbind(誤差_7變數,誤差_13變數))
colnames(誤差比較) <- c("迴歸7變數","迴歸13變數")
#誤差比較
x <- apply(誤差比較, 2, sum)
ans <- ifelse(x[[1]] < x[[2]], paste("7變數比13變數的誤差小，「7變數迴歸模型」較佳"),
                               paste("13變數比7變數的誤差小，「13變數迴歸模型」較佳"))
a <- paste("用7個變數所建立的迴歸模型，其預測誤差  =",x[1])
b <- paste("用13個變數所建立的迴歸模型，其預測誤差 =",x[2])
cat(format(Sys.time(), "%a %b %d %X %Y"),a,b,ans,sep ="\n")
```
>值得注意的是，無論是哪一組迴歸模型較優，其誤差之差異不大；有時「7變數迴歸模型」的預測誤差會比「13變數迴歸模型」的預測誤差來的大，有時「7變數迴歸模型」的預測誤差會比「13變數迴歸模型」的預測誤差來的小，這足以顯示並非迴歸模型的預測變數(自變數)愈多，其預測誤差會較小。據此，在建模的簡約原則下，「7變數迴歸模型」會較適當，這也是變數集群的主要目的，我們可應用R套件{ClustOfVar}來完成變數集群的工作。

>另外，亦可將兩組模型預測誤差比較結果存入檔案，以利日後查閱追蹤。

```{r}
cat(format(Sys.time(), "%a %b %d %X %Y"),a,b,ans, "================================================",
    sep ="\n", file="誤差比較結果.txt",append=TRUE)
```

>
>若想將上述預測誤差比較重複n次，並將比較結果寫入檔案，以檢視「7變數迴歸模型」或「13變數迴歸模型」何者較優時，可在原R碼加上for...loop的迴圈即可，亦可參考https://github.com/ccwatnkfust/nstc的「比較7個變數與13個變數的線性預測_n次.R」程式碼。</font>

